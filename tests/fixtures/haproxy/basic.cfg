global
    maxconn 4096
    nbthread 4
    log /dev/log local0

defaults
    mode http
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    option httplog

frontend http_front
    bind *:80
    bind *:443 ssl crt /etc/ssl/certs/server.pem

    # ACL definitions
    acl is_api path_beg /api
    acl is_admin path_beg /admin
    acl is_static path_beg /static
    acl host_api hdr(host) -i api.example.com

    # Rate limiting via stick-table
    stick-table type ip size 100k expire 30s store http_req_rate(10s)
    http-request track-sc0 src
    http-request deny deny_status 429 if { sc_http_req_rate(0) gt 100 }

    # Auth for admin
    http-request auth realm Admin if is_admin

    # Routing
    use_backend api_servers if is_api
    use_backend static_servers if is_static
    default_backend web_servers

backend api_servers
    balance leastconn
    option httpchk GET /health
    server api1 10.0.0.1:8080 weight 5 check
    server api2 10.0.0.2:8080 weight 3 check
    server api3 10.0.0.3:8080 backup check

backend static_servers
    balance roundrobin
    server static1 10.0.1.1:80 check
    server static2 10.0.1.2:80 check

backend web_servers
    balance source
    server web1 10.0.2.1:8080 check maxconn 100
    server web2 10.0.2.2:8080 check maxconn 100

listen stats
    bind *:8404
    stats enable
    stats uri /stats
